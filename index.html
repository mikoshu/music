<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>蓝蚁音效播放器</title>
<link href="css/bofang_lay.css" rel="stylesheet" type="text/css" />
</head>

<body class="default">
<div class="bianju_650">
	<div class="top_banner mid-hide">
        <a href="javascript:;" class="logo"></a>
    	<div class="denglu_24bk" id="show-login">
        	<a href="javascript:;">
        	<div class="denglu_img" ><img id="avatar" src="images/ic_head.png" width="22" height="22" /></div>
            <div class="denglu_txt" >
                <span id="nickname">登录</span>
            </div>
            </a>
		</div>
        <div class="top_jiantou miniHide">
        	<a href="javascript:;" id="win-back" ><img src="images/arrow_left.png" width="14" height="14" /></a>
            <a href="javascript:;" id="win-next" ><img src="images/arrow_right.png" width="14" height="14" /></a>
            <a href="javascript:;" id="reload"><img src="images/ic_renew.png" width="14" height="14" /></a>
        </div>
        <div class="top_sousuo miniHide">
        <form action="" method="get">
        	<div class="sousuo_input_bk"><input name="textfield" type="text" class="ss_input" id="textfield" placeholder="搜索音效、电音基调..." /></div>
            <div class="sousuo_anniu"><input type="button" class="sousuo_but" value="  " /></div>
        </form>
        </div>
        <div class="ico_youjian miniHide"><img src="images/ic_mail.png" width="16" height="16" /></div>
        <div class="ico_shezhi miniHide">
            <img src="images/ic_setting.png" width="16" height="16" />
        </div>
        <div class="mini" id="mini"></div>
        <div class="ico_suoxiao miniHide" ><img src="images/ic_shrink.png" width="16" height="16" /></div>
        <div class="ico_xiao"></div>
        <div class="ico_close"><img src="images/ic_off.png" width="16" height="16" /></div>
	</div>
	<div class="mid_bk">
    	<div class="mid_left mid-hide">
            <div class="clearfix">
                <div class="left_bbanner">
                    <a href="javascript:;" title="试听列表" class="tabs"><img src="images/sidebar_ic_list.png" alt="" /></a>
                    <a href="javascript:;" title="本地音效" class="on tabs"><img src="images/sidebar_ic_laptop.png"/></a>
                    <a href="javascript:;" title="下载列表" class="tabs"><img src="images/sidebar_ic_download.png" /></a>
                    <!-- <a href="javascript:;" title="电音查询记录"><img src="images/sidebar_ic_elecvoice.png"  /></a> -->
                    <a href="javascript:;" title="收藏列表" class="tabs" ><img src="images/sidebar_ic_like.png" /></a>
                </div>
                <div class="liebiao_list">
                    <!-- <div class="shiting_bk">
                        <div class="shiting_left"><img src="images/shiting_ico.png" width="21" height="17" /></div>
                        <div class="shiting_right"><img src="images/xiazai_ico.png" width="17" height="16" /></div>
                    </div> -->
                    <div>
                        <div class="moren_list on">
                            <p class="mrlink_lb">最近播放</p>
                            <span></span>
                        </div>
                        <ul id="recentList" class="gai_list_2">
                        </ul>
                    </div>
                    <div class="local-con" style="display: block;">
                        <div class="moren_list on">
                            <p class="mrlink_lb">默认列表</p>
                            <span></span>
                        </div>
                        <ul id="defaultList" class="gai_list_2">
                            
                        </ul>
                        
                    </div>
                    <div>
                        <div class="moren_list on">
                            <p class="mrlink_lb">下载列表</p>
                            <span></span>
                        </div>
                        <ul id="downloadList" class="gai_list_2" style="height:236px">

                        </ul>
                    </div>
                    <div class="favorite-con" >
                        <div class="moren_list on">
                            <p class="mrlink_lb">收藏列表</p>
                            <span></span>
                        </div>
                        <ul id="favoriteList" class="gai_list_2" style="height:236px">

                        </ul>
                    </div>
                    
                </div>
                <div class="ce_ad_bk" id="ad1">
                    <img src="images/ce_ad.jpg" width="195" height="87" />
                </div>
            </div>
            
        </div>
        <div class="mid_right miniHide">
            <div class="nr_ad mid-hide">
                <div class="nr_ad_left" id="ad2">
                 <img  src="" alt="" width="332" height="58" />   
                </div>
                <div class="nr_ad_right" id="ad3">
                    <img src="" alt="" width="106" height="58" />
                </div>
            </div>
        	<div class="nr_banner mid-hide">
            	<ul id="tab">
                	<li data-name="tab-my" class="nr_banner_jg">我的音效</li>
                    <li data-name="tab-lib" >音效库</li>
                    <li data-name="tab-search">电音库</li>
                    <li data-name="tab-tool">直播工具</li>
                </ul>
            </div>
            
            <div class="tiaoshi_bk">
            	<div class="tiaoshi_left_tu"><img src="images/content_ic_voice.png" width="20" height="20" /></div>
				<div class="tiaoshi_left_txt" id="ad4">声卡调试</div>
				<!-- <div class="tiaoshi_left_txt">就找图腾音频</div> -->
                <div class="mid-close"></div>
                <div class="toggle_onoff"><a id="sort" href="javascript:;"></a></div>
                <div class="tiaoshi_right_jia" title="重新加载音频文件" ><img src="images/content_ic_plus.png" width="18" height="18" /></div>
                <input type="file" id="file" style="display: none"  nwdirectory >
            </div>
            <div class="list_shengxiao" id="tab-my" style="display: block;">
            	<ul class="clearfix" id="musicList">
                	<!--遍历文件夹音效内容-->
                </ul>
            </div>
            <div class="list_shengxiao clearfix" id="tab-lib">
                <div class="lib-side" id="lib-side">
                    <!-- <div class="lib-mod"> 模板
                        <h3>人物音效</h3>
                        <ul>
                            <li>掌声</li>
                            <li>掌声</li>
                            <li>掌声</li>
                            <li>掌声</li>
                            <li>掌声</li>
                            <li>掌声</li>
                        </ul>
                    </div> -->
                </div>
                <div class="lib-con" >
                    <div id="lib-con"></div>
                    <div class="page"></div>
                    <!-- <h3>掌声</h3> 模板
                    <table>
                        <tr>
                            <th>标题</th>
                            <th>类型</th>
                            <th>时长</th>
                            <th>操作</th>
                        </tr>
                        <tr>
                            <td>生么法</td>
                            <td>掌声</td>
                            <td>3s</td>
                            <td>...</td>
                        </tr>
                    </table> -->
                </div>
            </div>
            <div class="list_shengxiao" id="tab-search">
                <iframe src="http://101.37.27.68/v21/query" width="454" height="288" frameborder="0"></iframe>
            </div>
            <div class="list_shengxiao" id="tab-tool">
                直播工具...
            </div>
        </div>
    </div>
    <div class="bofang_bk">
        <dl class="jindu_shang clearfix">
            <dd>
                <img src="images/control_image_cd.png" alt="" />
            </dd>
            <dt>
                <p id="name"></p>
                <span id="type" >HD</span>
            </dt>
        </dl>
    	<div class="bofang_1 mid-hide" id="last" ></div>
        <div class="bofang_2" id="play" ></div>
        <div class="bofang_3 mid-hide" id="next" ></div>
        <canvas id="mini-progress" class="circle-progress"></canvas>
        <div class="border"></div>
        <div class="jindu_bk miniHide">
        	
            <div class="jindu_xia">
            	<div class="jindu_shijian" id="allTime">00:00</div>
                <div class="jindu_tiao">
                    <p class="process"></p>
                </div>
                <div class="jindu_shijian" id="nowTime">00:00</div>
            </div>
        </div>
        <div class="bofang_4 miniHide mid-hide" id="delete"></div>
        <div class="favorite mid-hide" id="favorite"></div>
        <div class="circle mid-hide" id="circle" title="单曲播放"></div>
        <div class="bofang_7 miniHide"></div>
        <div class="shengyin_jindu miniHide" id="volume">
		  <p class="volume"></p>
        </div>
         <div class="ce_duihua miniHide mid-hide">
             <span>2</span>
         </div>
        <div class="to-max"></div>
        <div class="mini-volume">
            <input type="range" id="mVolume" min="0" max="100"  />
        </div>
        <span class="mini-type" id="miniType">HD</span>
	</div>
</div>
<audio id="audio" autoplay="autoplay" src='' ></audio>
<!--右键弹窗-->
<div class="pop">
    <a href="javascript:;" id="rename">重命名</a>
    <a href="javascript:;" id="addShortCuts" >添加快捷键</a>
    <a href="javascript:;" id="rightDelete" >删除</a>
</div>
<!--右键弹窗结束-->
<!--重命名弹窗-->
<div class="shortCutsPop">
    <label>
        音效名： 
        <span id="shortCutsName">你猜什么</span>
    </label>
    <label>
        快捷键：
        <input type="text" id="shortCutsInput" />
    </label>
    <p>提示：快捷键支持 ctrl+字母、alt+字母、shift+字母或者单个字母数字，其他快捷键组合暂不支持！</p>
    <p style="text-align: center">（输入快捷键时请确保键盘处于英文输入状态）</p>
    <div class="btn-box">
        <a href="javascript:;" id="shortCutsSure">确定</a>
        <a href="javascript:;" id="shortCutsCancel" >取消</a>
    </div>
</div>
<!--重命名弹窗结束-->
<!--设置弹窗-->
<div class="setPop clearfix">
    <div class="pop-head">基础设置</div>
    <div class="set-left">
        <a class="on" href="javascript:;">热键</a>
        <a href="javascript:;">音频设置</a>
        <a href="javascript:;">其他</a>
    </div>
    <div class="set-con">
        <div class="set-tab" style="display: block">
            <h3>快捷键设置</h3>
            <div class="table-box">
                <table class="table" cellspacing="0" cellpadding="0" >
                    <tr>
                        <th>名称</th>
                        <th>快捷键</th>
                        <th>操作</th>
                    </tr>
                    <tbody id="shortCutsList">
                    </tbody>
                    
                </table>
            </div>
        </div>
        <div class="set-tab">
            <div class="choose-box">
                <h3>音频输出设置</h3>
                <select class="chooseAudio">
                
                </select>
            </div>
        </div>
        <div class="set-tab">
            <h3>其他设置</h3>
            <label class="set-config">
                <input type="checkbox" id="realClose" />
                关闭程序时最小化到系统托盘
            </label>
        </div>
        <div class="btn-box">
            <!-- <a href="javascript:;" class="set-sure">确定</a> -->
            <a href="javascript:;" class="set-cancel">关闭</a>
        </div>
    </div>
</div>
<!--设置弹窗结束-->
<!--登录弹窗-->
<div class="login-box">
    <div class="pop-head">登录</div>
    <div class="login-con">
        <p id="msg" class="msg"></p>
        <ul>
            <li class="clearfix">
                <span>账号：</span>
                <input type="text" id="username" placeholder='请输入账号' />
                <a href="javascript:;" class="hrefTo" data-url="http://101.37.27.68/register.html" >注册账号</a>
            </li>
            <li class="clearfix">
                <span>密码：</span>
                <input type="password" id="password" placeholder='请输入密码' />
                <a href="javascript:;" class="hrefTo" data-url="http://101.37.27.68/password_find.html" >忘记密码</a>
            </li>
        </ul>
        <label>
            <input type="checkbox" id="autoLogin" />
            自动登录
        </label>
        <div class="btn-box">
            <a href="javascript:;" id="login-sure">确定</a>
            <a href="javascript:;" id="login-cancel" >取消</a>
        </div>
    </div>
    
</div>
<!--登录弹窗结束-->
<!--重命名弹窗-->
<div class="rename-pop">
    <label>
        原文件名： 
        <span id="oldName">你猜什么</span>
    </label>
    <label>
        新文件名：
        <input type="text" id="newName" />
    </label>
    <p style="text-align: center">（文件名请勿超过6个字）</p>
    <div class="btn-box">
        <a href="javascript:;" id="rename-sure">确定</a>
        <a href="javascript:;" id="rename-cancel" >取消</a>
    </div>
</div>
<!--重命名弹窗结束-->

<script type="text/javascript" src="js/jquery-2.1.1.min.js" ></script>
<script src="js/jquery.pagination.min.js"></script>
<script type="text/javascript" src="js/Sortable.js" ></script>
<script type="text/javascript" src="js/util.js" ></script>
<!-- <script type="text/javascript" src="js/cbsplit.js"></script>
<script type="text/javascript" src="js/jquery.ba-hashchange.js"></script>
<script type="text/javascript" src="js/jquery.router.js"></script> -->
<script>
    var fs = require('fs');
    var path = require('path');
    var Download = require('download');
    var musicURL = path.join(process.cwd(),'player/musics/');
    var downloadURL = path.join(process.cwd(),'player/download/');
    var index = 0; // 默认选中第一个音效
    var allFile = []; // 全部音效文件
    var favoriteFile = []; // 喜欢的音效文件
    var recentFile = []; // 最近播放的音效文件
    var downloadFile = []; // 下载列表
    var libFile = []; // 音效库内文件列表
    var file = []; // 执行遍历的临时文件数组
    var isPlaying = false;
    var playMode = 'one';
    var nowType = 'default'; // 记录当前播放列表类型，不同类型对应不同行为
    var audio = document.getElementById('audio');
    var Timmer;
    var shortCutsArray = []; // 存储快捷键
    var unreg = []; // 存储删除快捷键函数
    var gui = require('nw.gui');
    var tray;
    var canvas = document.getElementById("mini-progress"); // 环形进度条 canvas
    var cxt = canvas.getContext('2d');
    canvas.width = 32;
    canvas.height = 32;
    var mVolume = document.getElementById('mVolume');
    var playCircle = false;


    $(document).ready(function(){
        util.init(); // 初始化
        util.refreshList(); // 渲染列表

        /***topbar功能***/
        $(".ico_close").click(function(){
            util.close();
        });
        $(".mid-close").click(function(){
            util.close();
        });
        $(".ico_xiao").click(function(){
            var win = nw.Window.get();
            win.minimize()
        });
        $(".ico_suoxiao").click(function(){ // 主题部分mini
            var win = nw.Window.get();
            win.width = 454;
            win.height= 308;
            $(".tiaoshi_bk").addClass('midTool');
            $(".mid-hide").hide();
            $(".bofang_bk").addClass('midFooter');
            $(".mid_bk").css('height','auto');
            $(".bofang_7").addClass('ml-10');
            $('.to-max').show();
        });
        $(".to-max").click(function(){
            var win = nw.Window.get();
            $(".mid-hide").show();
            $(".bofang_bk").removeClass('midFooter');
            $(".mid_bk").css('height','354px');
            $(".bofang_7").removeClass('ml-10');
            $(".tiaoshi_bk").removeClass('midTool');
            $(this).hide();
            win.width = 660;
            win.height= 451;
            setTimeout(function(){
                win.width = 660;
                win.height= 450;
            },50)
        });
        $("#reload").click(function(){ // 刷新页面
           util.reload();
        })
        $('#mini').click(function(){ // 列表 mini 隐藏不显示元素
            var win = nw.Window.get();
            if($(this).hasClass('mini')){
                win.width = 205;
                $(".miniHide").hide();
                $(this).attr('class','minied');
                $(".bofang_bk").addClass('miniFooter');
                $(".login-box").addClass('mini-login');
                $(".denglu_txt").addClass('short-name');
            }else{
                win.width = 660;
                $(".miniHide").show();
                $(this).attr('class','mini');
                $(".bofang_bk").removeClass('miniFooter');
                $(".login-box").removeClass('mini-login');
                $(".denglu_txt").removeClass('short-name');
            }
            
        });
        $("#win-back").click(function(){
            history.back();
        });
        $("#win-next").click(function(){
            history.forward();
        });
        /***topbar功能***/
       
        /**音频事件绑定**/
        audio.onplaying = function(){ // 音频播放
            isPlaying = true;
            var url = $(audio).attr('src');
            $("#allTime").html(util.getTime(audio.duration));
            $("#play").addClass('playing');// 改变播放按钮样式
            if(util.isFavorited(url)){
                $("#favorite").attr('class','favorited');
            }else{
                $("#favorite").attr('class','favorite');
            }
            $("#musicList").find('a').each(function(i,val){
                if($(val).attr('data-url') == url ){
                    $(val).parent().addClass('on').siblings('li').removeClass('on');
                    return
                }
            });
            
            Timmer = setInterval(function(){ //控制时间与进度条
                $("#nowTime").html(util.getTime(audio.currentTime));
                var per = parseInt((audio.currentTime/audio.duration)*100);
                $(".process").css('width',per+'%');
                cxt.clearRect(0,0,32,32);
                cxt.beginPath();
                cxt.lineWidth = 3;
                cxt.strokeStyle = "#4CAEFB";
                cxt.arc(16,16,13,0,Math.PI*2*per/100,false);
                cxt.stroke();
            },200)
        }

        audio.onpause = function (){// 音频暂停
            isPlaying = false;
            $("#play").removeClass('playing');// 改变播放按钮样式
            clearInterval(Timmer)
        }

        audio.onended = function(){ // 音频结束
            $("#nowTime").html(util.getTime(audio.duration))
            $(".process").css('width','100%');

            cxt.beginPath();
            cxt.arc(16,16,13,0,Math.PI*2,false);
            cxt.stroke();
            clearInterval(Timmer);
            if(playCircle){
                index = index == file.length-1 ? 0 : index+1;
                play(file);  
            }
        }

        audio.onerror = function(err){
            var host = window.location.href;
            //console.log(audio.src);
            if( audio.src.indexOf('chrome-extension://') && audio.src != host ){ //此处为默认为空时返回url
                alert('该音效文件不存在或路径发生变化!')
            }
        }

        function play(fileList){
            var arr = []; // 每次播放用于存储更新最近播放列表
            if(fileList){
                file = fileList; // 播放时确定当前列表（默认/最近/喜欢）;
            }
            $("#audio").attr('src',file[index].fileURL);
            $("#name").html(file[index].fileName);
            $("#name").attr('title',file[index].fileName);
            var type = file[index].fileURL.split('.').pop().toUpperCase();
            $("#type").text(type);
            $("#miniType").text(type);
            audio.play();
            console.log(nowType)
            if(nowType != 'recent'){ // 当最近播放列表点击播放时，不更新自身
                recentFile.map(function(val,i){
                    if(val.fileName == file[index].fileName){
                        recentFile.splice(i,1);
                    }
                });
                recentFile.unshift(file[index]);
                localStorage.recentFile = JSON.stringify(recentFile);
                util.renderSideList('recentList',recentFile);
                if(nowType == 'default'){
                    util.sideListAddClass('defaultList',allFile,allFile[index].fileURL);
                }else if(nowType == 'favorite'){
                    util.sideListAddClass('favoriteList',favoriteFile,favoriteFile[index].fileURL);
                }else if(nowType == 'download'){
                    util.sideListAddClass('downloadList',downloadFile,downloadFile[index].fileURL);
                }
            }
            
            
        }
        /**音频事件绑定**/


        $("#musicList").delegate('li','click',function(){ // 点击音效列表播放音效
            file = allFile;
            nowType = 'default';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play();
            var url = $(this).find('a').attr('data-url');
            util.sideListAddClass('defaultList',allFile,url); // 右侧列表添加选中样式
            //util.sideListAddClass('recentList',recentFile,url); // 右侧列表添加选中样式
            //util.sideListAddClass('favoriteList',favoriteFile,url); // 右侧列表添加选中样式
        })

        $("#play").click(function(){ // 点击播放按钮事件（此处按钮样式需要改变）
            var url = $("#audio").attr('src');
            if(url == ''){
                $("#audio").attr('src',file[index].fileURL);
                $("#name").text(file[index].fileName);
                $("#type").text(file[index].fileURL.split('.').pop().toUpperCase());
            }
            if(isPlaying){
                audio.pause()
            }else{
                audio.play();
                if(nowType != 'recent'){ // 当最近播放列表点击播放时，不更新自身
                    recentFile.map(function(val,i){
                        if(val.fileName == file[index].fileName){
                            recentFile.splice(i,1);
                        }
                    });
                    recentFile.unshift(file[index]);
                    localStorage.recentFile = JSON.stringify(recentFile);
                    util.renderSideList('recentList',recentFile);
                }
            }
            
        })
        $("#last").click(function(){ // 上一首
            index -= 1;
            if(index == -1){
                alert('已经是第一首');
                index = 0;
            }else{
                util.chooseStyle();
                play();  
            } 
        })
        $("#next").click(function(){ // 下一首
            index += 1;
            if(index == file.length){
                alert('已经是最后一首');
                index = index - 1;
            }else{
                util.chooseStyle();
                play(); 
            } 
        })
        $("#delete").click(function(){
            var url = $(audio).attr('src');
            var name = $("#name").text();
            if(name != ''){
                var flag = util.deleteFile(url,name);
                if(flag){
                    $(audio).attr('src','');
                    $("#name").text('');
                    $(".process").css('width',"0%");
                    $("#play").attr('class','bofang_2');
                }
            }
        });

        $("#favorite").click(function(){ // 点击喜欢
            var dom = $(this);
            var url = $(audio).attr('src');
            var name = $("#name").text();
            var time = file[index].Time;
            if(name != ''){
                if(dom.hasClass('favorite')){
                    util.addToFavorite(dom,url,name,time);
                }else{
                    util.removeFromFavorite(dom,url,name);
                }
                util.renderSideList('defaultList',allFile);
                util.renderSideList('recentList',recentFile);
            }
            
        })

        $("#circle").click(function(){ // 循环播放
            var $this = $(this);
            if($this.hasClass('circle')){
                $this.attr('class','circled1');
                $this.attr('title','单曲循环');
                audio.loop = true;
                playCircle = false;
            }else if($this.hasClass('circled1')){
                $this.attr('class','circled2');
                $this.attr('title','列表循环');
                audio.loop = false;
                playCircle = true;
            }else{
                $this.attr('class','circle');
                $this.attr('title','单曲播放');
                audio.loop = false;
                playCircle = false;
            }
        })

        

        /** 声音控制器模拟 **/

        var changeVolume = false;
        var maxWidth = 47;
        $("#volume").mousedown(function(){
            changeVolume = true;
        })
        $("#volume").mouseup(function(e){
            changeVolume = false;
            getPer(e);
        })
        $("body").mouseup(function(){
            changeVolume = false;
        })
        $('body').mousemove(function(e){
            if(changeVolume){
                getPer(e)
            }
        })

        function getPer(e){ // 音量获取
            var left = (e.clientX - $("#volume")[0].getBoundingClientRect().left);
            if(left < 0){
                left = 0;
            }else if(left > maxWidth){
                left = maxWidth;
            }
            var per = parseInt((left / maxWidth)*100);
            $("#volume").find('p').css('width',per+'%');
            audio.volume = per/100;
        } 
        /**声音控制器模拟结束 **/
        /**mini声音控制**/

        $(".mini-volume").click(function(e){
            mVolume.value = audio.volume*100;
            mVolume.style.display = 'block';
            e.stopPropagation();  
        });

        $('body').on('click',function(e){
            mVolume.style.display = 'none';    
        });

        $(mVolume).on('click',function(e){
            e.stopPropagation();  
        });

        $(mVolume).on('input',function(e){
            var wlen = $(this).val();
            audio.volume = wlen/100;

            $("#volume").find('p').css('width',wlen+'%');
        });

        /**mini声音控制结束**/
        

        /***排序按钮开关***/
        var s;
        $("#sort").on('click',function(){
            if($(this).hasClass('on')){
                $(this).removeClass('on');
                $(".list_shengxiao").removeClass('sort');
                s.destroy();
            }else{
                $(this).addClass('on');
                $(".list_shengxiao").addClass('sort');
                var bar = document.getElementById('musicList');
                s = Sortable.create(bar, {  // 用sortable实现可拖拽排序
                    animation: 150,
                    onEnd: function(){ // 排序结束后更改localstorage.file文件
                        util.getMainList();
                        util.renderSideList('defaultList',allFile);// 重新渲染左侧默认列表
                    }
                });
            }
        })

        
        /**主列表删除**/
        $("#musicList").delegate('span','click',function(e){
            e.stopPropagation();
            var fileURL = $(this).parent().attr('data-url');
            var fileName = $(this).parent().text();
            util.deleteFile(fileURL,fileName);
        });

        /**左侧列表**/
        $(".tabs").click(function(){
            $(this).addClass('on').siblings('.tabs').removeClass('on');
            var eq = $(this).index();
            $(".liebiao_list > div").eq(eq).show().siblings('div').hide();
        });
       

        $(".moren_list").click(function(){
            $(this).toggleClass('on').siblings('.moren_list').removeClass('on');
        })

        $("#defaultList").delegate('li','click',function(){ //默认列表点击事件
            nowType = 'default';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play(allFile);
        });
        
        

        $("#recentList").delegate('li','click',function(){ //最近播放列表点击事件
            nowType = 'recent';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play(recentFile);
        });

        $("#favoriteList").delegate('li','click',function(){ //最近播放列表点击事件
            nowType = 'favorite';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play(favoriteFile);
        });
        $("#downloadList").delegate('li','click',function(){ //最近播放列表点击事件
            nowType = 'download';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play(downloadFile);
        });

        $('.gai_list_2').delegate('.favorite','click',function(e){ //添加音效到喜欢列表
            e.stopPropagation();
            var name = $(this).parent().find('p').text();
            var url = $(this).parent().attr('data-url');
            var time = $(this).parent().find('.time').html();
            util.addToFavorite($(this),url,name,time);
            util.renderSideList('defaultList',allFile);
            util.renderSideList('recentList',recentFile);
        });

        $('.gai_list_2').delegate('.favorited','click',function(e){ //从喜欢列表移除音效
            e.stopPropagation();
            var name = $(this).parent().find('p').text();
            var url = $(this).parent().attr('data-url');
            util.removeFromFavorite($(this),url,name);
            util.renderSideList('defaultList',allFile);
            util.renderSideList('recentList',recentFile);
        });
        $(".gai_list_2").delegate('.delete','click',function(e){ //列表删除文件
            e.stopPropagation();
            var name = $(this).parent().find('p').text();
            var url = $(this).parent().attr('data-url');
            util.deleteFile(url,name);
        });

        /**左侧列表**/

        $(".tiaoshi_right_jia").click(function(){
            $("#file").trigger('click');
            // var sure = confirm("重置播放器将删除所有记录，是否继续？");
            // if(sure){
            //     localStorage.clear();
            //     window.location.reload();
            // } 
        })
        $("#file").on('change',function(){
            var folder = $(this).val();
            console.log($(this).val());
            var newAddFile = []; 
            var callback = function(){
                allFile = allFile.concat(newAddFile);
                localStorage.file = JSON.stringify(allFile);
                util.refreshList();
            }
            util.readFile(folder,newAddFile,callback);
        })

        /**右键添加快捷键**/
        var win_width = window.innerWidth;
        var win_height = window.innerHeight;
        var pop_w = $(".pop").width();
        var pop_h = $(".pop").height();
        var shortCutsObj = {};
        var codeArray = []; // 记录快捷键键值
        $("#musicList").delegate('a','mousedown',function(e) { // 显示右键弹窗
            if(e.button == '2'){
                var x = e.clientX;
                var y = e.clientY;
                var name = $(this).text();
                var url = $(this).attr('data-url');
                $(".pop").show().css({'left':x+'px','top':y+'px','right':'auto','bottom':'auto'});
                if(x > win_width - pop_w){
                    $(".pop").show().css({'right':'0px','left':'auto'});
                }
                if(y > win_height - pop_h){
                    $(".pop").show().css({'bottom':'0px','top':'auto'});
                }
                shortCutsObj.name = name;
                shortCutsObj.url = url;
                e.stopPropagation();
            }
        });
        $(document).click(function(event) {
            $(".pop").hide()
        });

        $("#addShortCuts").click(function(){ // 显示添加快捷键弹窗
            $("#shortCutsName").text(shortCutsObj.name);
            $("#shortCutsInput").val("");
            $(".shortCutsPop").show(); 
            $("#shortCutsInput").trigger('focus');        
        });

        $("#shortCutsCancel").click(function(){
            $(".shortCutsPop").hide(); 
        })
        var keyname = '';
        var l = new lastKey(function(code) {
            if( (code>64&&code<91)|| (code>47&&code<58) || code == 8 ||code == 16 || code == 17 || code == 18 ){
               if(code == 17){
                    keyname += '+Ctrl';
                }else if(code == 18){
                    keyname += '+Alt';
                }else if(code == 16){
                    keyname += '+Shift';
                }else if(code == 8){
                    keyname = '';
                    $("#shortCutsInput").val('');
                }else{
                    keyname += '+'+String.fromCharCode(code);
                } 
            }else{
                alert('暂不支持此快捷键');
                return 
            }
            
            $("#shortCutsInput").val(keyname.substring(1,keyname.length));
            //keyname.substring(1,keyname.length)
            
        })
        $("#shortCutsInput").keydown(function(e) {  //  添加快捷键
            var code = e.keyCode;
            l.of(code)
            //var value = this.value + String.fromCharCode(e.keyCode);
            e.stopPropagation();
            e.preventDefault();
        }).keyup(function(e){
            keyname = '';
        });
        $(window).keydown(function(e) {
            var code = e.keyCode;
            if(code == 32){
                $("#play").trigger('click');
            }
        });

        $("#shortCutsSure").click(function(){
            var txt = $("#shortCutsInput").val();
            if(txt == ''){
                alert('请输入需要设定的快捷键值！');
                return
            }else{
                var obj = {};
                obj.name = shortCutsObj.name;
                obj.key = txt;
                obj.url = shortCutsObj.url;
                shortCutsArray.push(obj);
                util.addShortCuts(txt,shortCutsObj.url,shortCutsObj.name);
                alert('添加快捷键成功！');
                localStorage.shortCutsArray = JSON.stringify(shortCutsArray);
                $(".shortCutsPop").hide();
                util.renderShortCutsList(); // 刷新快捷键列表
            }
        })
        /** 重命名事件触发 **/
        $("#rename").on('click',function(e){
            $(".rename-pop").css("display","block");
            $("#oldName").text(shortCutsObj.name);
            $("#newName").val(shortCutsObj.name);
            $("#newName").trigger('focus');
        });
        $("#rename-cancel").on('click',function(e){
            $(".rename-pop").css("display","none");
        });
        $("#rename-sure").on('click',function(e){
            var newName = $("#newName").val();
            var obj = {
                newName: newName,
                oldName: shortCutsObj.name,
                oldURL : shortCutsObj.url
            }
            if(newName == ''){
                alert("文件名不能为空！");
            }else if(newName.length > 6){
                alert("文件名长度不能超过6个字！");
            }else{
                util.rename(obj);
                $(".rename-pop").css("display","none");
            }
        });
        /** 重命名事件触发 **/
        /**右键删除**/
        
        $("#rightDelete").on('click',function(){
            util.deleteFile(shortCutsObj.url,shortCutsObj.name)
        }) 
        

        $(".ico_shezhi").on('click',function(){
            $(".setPop").show();
        })
        $(".set-cancel,.set-sure").click(function(){
            $(".setPop").hide();
        })
        $(".set-left a").click(function(){ // 设置弹窗左侧切换
            var eq = $(this).index();
            $(this).addClass('on').siblings('a').removeClass('on');
            $(".set-tab").eq(eq).show().siblings('.set-tab').hide();
        })

        $(".setPop").delegate('.removeShortCut', 'click', function(e) {
            var i = $(this).attr('data-index');
            shortCutsArray.splice(i,1);
            localStorage.shortCutsArray = JSON.stringify(shortCutsArray);
            unreg[i]();
            unreg.splice(i,1);
            util.renderShortCutsList();
        });

        $(".chooseAudio").on('change',function(e){ // 选择音频输出设备函数
            var id = $(this).val();
            localStorage.channel = id;
            if (typeof audio.sinkId !== 'undefined') {
                audio.setSinkId(id).then(function(resp) {
                    console.log('Success, audio output device attached: ' + id + ' to ' +
                      'element with ' + audio.title + ' as source.');

                });
              } else {
                console.warn('Browser does not support output device selection.');
              }
        });

        /**登录弹窗事件**/
        $("#show-login").click(function(){
            if($(this).hasClass('logined')){
                util.logout()
            }else{
                $('.login-box').show();
            }
            
        });

        $("#login-cancel").click(function(){
            $('.login-box').hide();
        });

        $(".hrefTo").click(function(){
            var url = $(this).attr('data-url');
            nw.Shell.openExternal(url);
        });

        $("#login-sure").click(function(){
            var username = $("#username").val();
            var password = $("#password").val();
            util.login(username,password);
        })

        $("#autoLogin").change(function(){
            var checked = $(this).prop('checked')
            if(checked){
                localStorage.isAutoLogin = checked;
            }else{
                localStorage.isAutoLogin = '';
            }
            
        });
        $("#logout").click(function(){
            util.logout();
        })
        // 设置是否关闭到系统托盘
        $('#realClose').change(function(){
            var isClose = $(this).prop('checked');
            localStorage.isClose = isClose;
        });
        // 音效库以及相关内容切换
        $("#tab").find('li').on('click',function(e){
            var name = $(this).attr('data-name');
            window.location.href = '#'+name;
        });
        // 播放音效库文件
        $('body').delegate('.playthis','click',function(){
            var i = $(this).attr('data-index');
            $(this).parents('tr').addClass('on').siblings('tr').removeClass('on');
            index = i;
            play(libFile);
            util.renderSideList('recentList',recentFile);
            util.renderSideList('defaultList',allFile);
            util.renderSideList('favoriteList',favoriteFile);
        });
        $("body").delegate('.lib-show','click',function(e){
            if($(this).hasClass('on')){
                $(this).removeClass('on')
                $(this).next().css("height",'76px');
            }else{
                $(this).addClass('on')
                $(this).next().css("height",'auto');
            }
            
        });
        $("body").delegate('.lib-type','click',function(){
            var id = $(this).attr('data-id');
            util.renderLibHtmlCon(id,1);
        });
        // 下载音效库文件
        $("body").delegate('.toDownload','click',function(e){
            var url = $(this).attr("data-url");
            var name = $(this).attr("data-name");
            // Download(url, 'player/download').then(() => {
            //     alert("下载完成")
            // });
            Download(url).then(data => {
                fs.writeFile('player/download/'+name, data,{},(err)=>{
                    if(err){
                        alert(err);
                    }else{
                        alert("下载成功！");
                        util.readDownloadFolder();
                        //util.renderSideList('downloadList',downloadFile);
                    }
                });
            });

        })
        
    })

    $(window).bind('hashchange', function(e, triggered) { // 绑定hash值
            var hash = location.hash.replace(/^#/, '');
            if(hash != ''){
                $("#tab").find('li').each(function(i,val){
                    if($(val).attr("data-name") == hash ){
                        $(val).addClass('nr_banner_jg').siblings('li').removeClass('nr_banner_jg');
                    }
                })
                $("#"+hash).css('display','block').siblings('.list_shengxiao').css('display','none');
            }
    });

    function lastKey(callback) {
        this._last_key = ''
        this.keys = []
        this.callback = callback
    }
    lastKey.prototype.of = function(key) {
        if(key == this._last_key) {
            return
        }
        this._last_key = key
        this.keys.push(key)
        this.callback(key)
    }

    // $(document).on('keydown',function(event) {
    //      Act on the event 
    //     console.log(event.keyCode)
    // });

    

</script>
</body>
</html>
