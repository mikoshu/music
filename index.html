<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>蓝蚁音效播放器</title>
<link href="css/bofang_lay.css" rel="stylesheet" type="text/css" />
</head>

<body>
<div class="bianju_650">
	<div class="top_banner">
    	<div class="denglu_24bk">
        	<a href="#">
        	<div class="denglu_img"><img src="images/img_tx.png" width="24" height="26" /></div>
            <div class="denglu_txt">登录</div>
            </a>
		</div>
        <div class="top_jiantou miniHide">
        	<a href="#"><img src="images/left_ico.png" width="12" height="19" /></a>
            <a href="#"><img src="images/right_ico.png" width="11" height="19" /></a>
            <a href="javascript:;" id="reload"><img src="images/update_ico.png" width="20" height="20" /></a>
        </div>
        <div class="top_sousuo miniHide">
        <form action="" method="get">
        	<div class="sousuo_input_bk"><input name="textfield" type="text" class="ss_input" id="textfield" value="搜索音效、电音基调......" /></div>
            <div class="sousuo_anniu"><input type="button" class="sousuo_but" value="  " /></div>
        </form>
        </div>
        <div class="ico_youjian miniHide"><img src="images/mail_ico.png" width="19" height="15" /></div>
        <div class="ico_shezhi miniHide"><img src="images/shezhi_ico.png" width="14" height="15" /></div>
        <div class="mini" id="mini"></div>
        <div class="ico_suoxiao miniHide" ><img src="images/suoxiao_ico.png" width="16" height="16" /></div>
        <div class="ico_xiao"></div>
        <div class="ico_close"><img src="images/close_ico.png" width="15" height="16" /></div>
	</div>
	<div class="mid_bk">
    	<div class="mid_left">
        	<div class="left_bbanner">
            	<a href="#"><img src="images/left_ico_1.png" width="14" height="16" /></a>
                <a href="#" id="tab-local" class="on tabs"><img src="images/left_ico_2.png" width="14" height="16" /></a>
                <a href="#"><img src="images/left_ico_3.png" width="14" height="16" /></a>
                <a href="#"><img src="images/left_ico_4.png" width="14" height="16" /></a>
                <a href="#" class="tabs" id="tab-favorite" ><img src="images/left_ico_5.png" width="14" height="16" /></a>
            </div>
			<div class="liebiao_list">
            	<div class="shiting_bk">
                	<!--<div class="shiting_left"><img src="images/shiting_ico.png" width="21" height="17" /></div>-->
                    <div class="shiting_right"><img src="images/xiazai_ico.png" width="17" height="16" /></div>
                </div>
                <div class="local-con">
                    <div class="moren_list on">
                        <p class="mrlink_lb">默认列表</p>
                        <span></span>
                    </div>
                    <ul id="defaultList" class="gai_list_2">
                        
                    </ul>
                    <div class="moren_list">
                        <p class="mrlink_lb">最近播放</p>
                        <span></span>
                    </div>
                    <ul id="recentList" class="gai_list_2">
                    </ul>
                </div>
                <div class="favorite-con" style="display:none;">
                    <ul id="favoriteList" class="gai_list_2" style="display:block;height:188px;">

                    </ul>
                </div>
				
            </div>
			<div class="ce_back"><img src="images/back_tu.jpg" width="128" height="18" /></div>
            <div class="ce_ad_bk"><img src="images/ce_ad.jpg" width="195" height="87" /></div>
        </div>
        <div class="mid_right miniHide">
        	<div class="nr_banner">
            	<ul>
                	<li class="nr_banner_jg">我的音效</li>
                    <li>音效库</li>
                    <li>电音库</li>
                    <li>直播工具</li>
                </ul>
            </div>
            <div class="nr_ad">
            	<div class="nr_ad_left"></div>
                <div class="nr_ad_right"></div>
            </div>
            <div class="tiaoshi_bk">
            	<div class="tiaoshi_left_tu"><img src="images/vois_ico.png" width="16" height="16" /></div>
				<div class="tiaoshi_left_txt">声卡调试</div>
				<div class="tiaoshi_left_txt">就找图腾音频</div>
                <div class="toggle_onoff"><a id="sort"></a></div>
                <div class="tiaoshi_right_jia"><img src="images/jia_ico.png" width="14" height="14" /></div>
            </div>
            <div class="list_shengxiao">
            	<ul class="clearfix" id="musicList">
                	<!--遍历文件夹音效内容-->
                </ul>
            </div>
        </div>
    </div>
    <div class="bofang_bk">
    	<div class="bofang_1" id="last" ><img src="images/bofang_ico_1.png" width="23" height="20" /></div>
        <div class="bofang_2" id="play" ></div>
        <div class="bofang_3" id="next" ><img src="images/bofang_ico_3.png" width="23" height="20" /></div>
        <div class="jindu_bk miniHide">
        	<div class="jindu_shang">
            	<span><img src="images/bofang_ico_hd.png" width="25" height="18" /></span>
                <p id="name"></p>
		  </div>
            <div class="jindu_xia">
            	<div class="jindu_shijian" id="allTime">00:00</div>
                <div class="jindu_tiao">
                    <p class="process"></p>
                </div>
                <div class="jindu_shijian" id="nowTime">00:00</div>
            </div>
        </div>
        <div class="bofang_4 miniHide" id="delete"><img src="images/bofang_ico_4.png" width="12" height="16" /></div>
        <div class="favorite " id="favorite"></div>
        <div class="circle " id="circle"></div>
        <div class="bofang_7 miniHide"><img src="images/bofang_ico_7.png" width="17" height="12" /></div>
        <div class="shengyin_jindu miniHide" id="volume">
		  <p class="volume"></p>
        </div>
         <div class="ce_duihua miniHide">12</div>
	</div>
</div>
<audio id="audio" autoplay="autoplay" src='' ></audio>

<script type="text/javascript" src="js/jquery-2.1.1.min.js" ></script>
<script type="text/javascript" src="js/Sortable.js" ></script>
<script type="text/javascript" src="js/util.js" ></script>
<script>
    var fs = require('fs');
    var path = require('path');
    var musicURL = path.join(process.cwd(),'player/musics/');
    var index = 0; // 默认选中第一个音效
    var allFile = []; // 全部音效文件
    var favoriteFile = []; // 喜欢的音效文件
    var recentFile = []; // 最近播放的音效文件
    var file = []; // 执行遍历的临时文件数组
    var isPlaying = false;
    var playMode = 'one';
    var nowType = 'default'; // 记录当前播放列表类型，不同类型对应不同行为
    var audio = document.getElementById('audio');
    var Timmer;

    $(document).ready(function(){
        util.init(); // 初始化
        util.refreshList(); // 渲染列表

        /***topbar功能***/
        $(".ico_close").click(function(){
            var win = nw.Window.get();
            win.close()
        })
        $(".ico_xiao").click(function(){
            var win = nw.Window.get();
            win.minimize()
        })
        // $(".ico_suoxiao").click(function(){
        //     var win = nw.Window.get();
        //     win.maximize()
        // })
        $("#reload").click(function(){ // 刷新页面
            window.location.reload();
        })
        $('#mini').click(function(){ // mini 隐藏不显示元素
            var win = nw.Window.get();
            if($(this).hasClass('mini')){
                win.width = 195;
                $(".miniHide").hide();
                $(this).attr('class','minied');
                $(".bofang_bk").addClass('miniFooter');
            }else{
                win.width = 660;
                $(".miniHide").show();
                $(this).attr('class','mini');
                $(".bofang_bk").removeClass('miniFooter');
            }
            
        });
        /***topbar功能***/
       
        /**音频事件绑定**/
        audio.onplaying = function(){ // 音频播放
            isPlaying = true;
            var url = $(audio).attr('src');
            $("#allTime").html(util.getTime(audio.duration));
            $("#play").addClass('playing');// 改变播放按钮样式
            if(util.isFavorited(url)){
                $("#favorite").attr('class','favorited');
            }else{
                $("#favorite").attr('class','favorite');
            }
            Timmer = setInterval(function(){ //控制时间与进度条
                $("#nowTime").html(util.getTime(audio.currentTime));
                var per = parseInt((audio.currentTime/audio.duration)*100);
                $(".process").css('width',per+'%');
            },500)
        }

        audio.onpause = function (){// 音频暂停
            isPlaying = false;
            $("#play").removeClass('playing');// 改变播放按钮样式
            clearInterval(Timmer)
        }

        audio.onended = function(){ // 音频结束
            $("#nowTime").html(util.getTime(audio.duration))
            $(".process").css('width','100%');
            clearInterval(Timmer)
        }

        audio.onerror = function(err){
            if( audio.src.indexOf('chrome-extension://') ){ //此处为默认为空时返回url
                alert('该音效文件不存在或路径发生变化!')
            }
        }

        function play(fileList){
            var arr = []; // 每次播放用于存储更新最近播放列表
            if(fileList){
                file = fileList; // 播放时确定当前列表（默认/最近/喜欢）;
            }
            $("#audio").attr('src',file[index].fileURL);
            $("#name").html(file[index].fileName);
            audio.play();
            if(nowType != 'recent'){ // 当最近播放列表点击播放时，不更新自身
                recentFile.map(function(val,i){
                    if(val.fileName == file[index].fileName){
                        recentFile.splice(i,1);
                    }
                });
                recentFile.unshift(file[index]);
                localStorage.recentFile = JSON.stringify(recentFile);
                util.renderSideList('recentList',recentFile);
            }
            
        }
        /**音频事件绑定**/


        $("#musicList").delegate('li','click',function(){ // 点击音效列表播放音效
            file = allFile;
            nowType = 'default';
            index = $(this).index();
            play();
        })

        $("#play").click(function(){ // 点击播放按钮事件（此处按钮样式需要改变）
            var url = $("#audio").attr('src');
            if(url == ''){
                $("#audio").attr('src',file[index].fileURL);
            }
            if(isPlaying){
                audio.pause()
            }else{
                audio.play();
                if(nowType != 'recent'){ // 当最近播放列表点击播放时，不更新自身
                    recentFile.map(function(val,i){
                        if(val.fileName == file[index].fileName){
                            recentFile.splice(i,1);
                        }
                    });
                    recentFile.unshift(file[index]);
                    localStorage.recentFile = JSON.stringify(recentFile);
                    util.renderSideList('recentList',recentFile);
                }
            }
            
        })
        $("#last").click(function(){ // 上一首
            index -= 1;
            if(index == -1){
                alert('已经是第一首');
                index = 0;
            }else{
                util.chooseStyle();
                play();  
            } 
        })
        $("#next").click(function(){ // 下一首
            index += 1;
            if(index == file.length){
                alert('已经是最后一首');
                index = index - 1;
            }else{
                util.chooseStyle();
                play(); 
            } 
        })
        $("#delete").click(function(){
            var url = $(audio).attr('src');
            var name = $("#name").text();
            if(name != ''){
                util.deleteFile(url,name);
                $(audio).attr('src','');
                $("#name").text('');

            }
        });

        $("#favorite").click(function(){
            var dom = $(this);
            var url = $(audio).attr('src');
            var name = $("#name").text();
            if(name != ''){
                if(dom.hasClass('favorite')){
                    util.addToFavorite(dom,url,name);
                }else{
                    util.removeFromFavorite(dom,url,name);
                }
            }
            
        })

        $("#circle").click(function(){
            var $this = $(this);
            if($this.hasClass('circle')){
                $this.attr('class','circled');
                audio.loop = true;
            }else{
                $this.attr('class','circle');
                audio.loop = false;
            }
        })

        

        /** 声音控制器模拟 **/
        var changeVolume = false;
        var maxWidth = 47;
        $("#volume").mousedown(function(){
            changeVolume = true;
        })
        $("#volume").mouseup(function(e){
            changeVolume = false;
            getPer(e);
        })
        $("body").mouseup(function(){
            changeVolume = false;
        })
        $('body').mousemove(function(e){
            if(changeVolume){
                getPer(e)
            }
        })

        function getPer(e){ // 音量获取
            var left = (e.clientX - $("#volume")[0].getBoundingClientRect().left);
            if(left < 0){
                left = 0;
            }else if(left > maxWidth){
                left = maxWidth;
            }
            var per = parseInt((left / maxWidth)*100);
            $("#volume").find('p').css('width',per+'%');
            audio.volume = per/100;
        } 
        /**声音控制器模拟结束 **/

        

        /***排序按钮开关***/
        var s;
        $("#sort").on('click',function(){
            if($(this).hasClass('on')){
                $(this).removeClass('on');
                $(".list_shengxiao").removeClass('sort');
                s.destroy();
            }else{
                $(this).addClass('on');
                $(".list_shengxiao").addClass('sort');
                var bar = document.getElementById('musicList');
                s = Sortable.create(bar, {  // 用sortable实现可拖拽排序
                    animation: 150,
                    onEnd: function(){ // 排序结束后更改localstorage.file文件
                        util.getMainList();
                        util.renderSideList('defaultList',allFile);// 重新渲染左侧默认列表
                    }
                });
            }
        })

        
        /**主列表删除**/
        $("#musicList").delegate('span','click',function(e){
            e.stopPropagation();
            var fileURL = $(this).parent().attr('data-url');
            var fileName = $(this).parent().text();
            util.deleteFile(fileURL,fileName);
        });

        /**左侧列表**/
        $(".tabs").click(function(){
            $(this).addClass('on').siblings('.tabs').removeClass('on');
        });
        $("#tab-local").click(function(){
            $(".local-con").show();
            $(".favorite-con").hide();
        });
        $("#tab-favorite").click(function(){
            $(".local-con").hide();
            $(".favorite-con").show();
        });


        $(".moren_list").click(function(){
            $(this).toggleClass('on').siblings('.moren_list').removeClass('on');
        })

        $("#defaultList").delegate('li','click',function(){ //默认列表点击事件
            nowType = 'default';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play(allFile);
        });
        
        

        $("#recentList").delegate('li','click',function(){ //最近播放列表点击事件
            nowType = 'recent';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play(recentFile);
        });

        $("#favoriteList").delegate('li','click',function(){ //最近播放列表点击事件
            nowType = 'favorite';
            $(this).addClass('on').siblings('li').removeClass('on');
            index = $(this).index();
            play(favoriteFile);
        });

        $('#recentList,#defaultList,#favoriteList').delegate('.favorite','click',function(e){ //添加音效到喜欢列表
            e.stopPropagation();
            var name = $(this).parent().find('p').text();
            var url = $(this).parent().attr('data-url');
            util.addToFavorite($(this),url,name);
        });

        $('#recentList,#defaultList,#favoriteList').delegate('.favorited','click',function(e){ //从喜欢列表移除音效
            e.stopPropagation();
            var name = $(this).parent().find('p').text();
            var url = $(this).parent().attr('data-url');
            util.removeFromFavorite($(this),url,name);
        });
        $("#recentList,#defaultList,#favoriteList").delegate('.delete','click',function(e){ //列表删除文件
            e.stopPropagation();
            var name = $(this).parent().find('p').text();
            var url = $(this).parent().attr('data-url');
            util.deleteFile(url,name);
        });

        /**左侧列表**/



    })

    

</script>
</body>
</html>
